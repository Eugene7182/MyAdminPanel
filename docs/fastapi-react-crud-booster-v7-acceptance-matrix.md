# PROMPT_QA_ACCEPTANCE_MATRIX — FastAPI & React CRUD Booster V7.0

## # SCENARIOS
1. **Admin onboarding CRUD** — создать новую сущность (например, Store), настроить обязательные поля, проверить валидацию и отображение в списках.
2. **Manager data entry CRUD** — менеджер создаёт, редактирует и удаляет запись (Product) с проверкой аудита и подтверждения.
3. **Viewer read-only navigation** — просмотр списков и деталей сущности без прав на модификацию.
4. **Composite filter + сортировка + пагинация** — комбинированный поиск по нескольким полям, переключение сортировки и страниц.
5. **Role-based dashboard widgets** — проверка, что админ/менеджер/наблюдатель видят корректные виджеты и скрытые элементы UI.
6. **Bulk import & validation** — загрузка CSV/Excel с проверкой ошибок, превью и подтверждением.
7. **Real-time updates on secondary tab** — параллельное открытие вкладки «Real-time feed», обновление через WebSocket и синхронизация списка.
8. **WebSocket authorization refresh** — обновление токена и переподключение WS при истечении срока действия.
9. **Notifications & audit trail** — генерация уведомлений при CRUD-операциях и проверка записей аудита.
10. **Error handling & fallback UI** — симуляция серверных ошибок (4xx/5xx) и отображение сообщений на фронтенде.
11. **Access revocation mid-session** — изменение роли пользователя в административной панели и проверка немедленного пересчёта прав.
12. **External integration sync** — запуск задачи синхронизации (REST API import), проверка статуса и итогового набора данных.
13. **Offline-first & retry** — отключение сети на фронтенде, кэширование черновиков и повторная отправка.
14. **Export & permissions** — экспорт данных в CSV/PDF с проверкой ограничений по ролям.
15. **Feature flag toggle** — включение/выключение модуля (например, Bonuses) без перезапуска сервиса.
16. **Session timeout & re-auth** — автоматический логаут по таймауту, восстановление с refresh токеном.

## # TEST CASES
### Scenario 1 — Admin onboarding CRUD
- **Preconditions:** Пользователь admin авторизован; в системе нет сущности Store "MegaMall".
- **Steps:**
  1. Открыть раздел Stores.
  2. Нажать "Create".
  3. Заполнить обязательные поля (название, сеть, регион) и сохранить.
  4. Проверить появление записи в списке и карточке деталей.
- **Expected:** Запись сохраняется в БД, UI обновляется без ошибок, запись доступна другим ролям в режиме чтения.

### Scenario 2 — Manager data entry CRUD
- **Preconditions:** Пользователь manager авторизован; сущность Product "OPPO Reno" существует.
- **Steps:**
  1. Открыть карточку продукта.
  2. Изменить цену и сохранить.
  3. Удалить продукт.
  4. Проверить, что запись помечена как удалённая и не отображается в списке.
- **Expected:** Изменения фиксируются в истории, удаление возможно только при подтверждении, у viewer запись недоступна.

### Scenario 3 — Viewer read-only navigation
- **Preconditions:** Пользователь viewer авторизован; есть несколько сущностей разных типов.
- **Steps:**
  1. Перейти на Dashboard.
  2. Открыть списки Stores и Products.
  3. Попробовать отредактировать запись.
- **Expected:** Viewer видит данные, но не видит кнопок Create/Edit/Delete; попытки через прямую ссылку приводят к 403.

### Scenario 4 — Composite filter + сортировка + пагинация
- **Preconditions:** В системе >200 записей Products.
- **Steps:**
  1. Применить фильтр по сети и региону.
  2. Установить сортировку по цене по убыванию.
  3. Перейти на 3-ю страницу.
  4. Сбросить фильтры.
- **Expected:** Списки обновляются с корректными выборками, пагинация сохраняет состояние, сброс возвращает полный список.

### Scenario 5 — Role-based dashboard widgets
- **Preconditions:** Настроены виджеты для разных ролей.
- **Steps:**
  1. Войти под admin и сделать скриншот Dashboard.
  2. Выйти, войти под manager и viewer, повторить.
  3. Сравнить набор виджетов и действий.
- **Expected:** Каждый набор соответствует матрице прав; отсутствующие виджеты не рендерятся и не доступны через API.

### Scenario 6 — Bulk import & validation
- **Preconditions:** Подготовлен CSV с корректными и некорректными строками.
- **Steps:**
  1. Загрузить файл через UI.
  2. Проверить предпросмотр ошибок.
  3. Подтвердить импорт.
  4. Проверить, что только валидные строки сохранены.
- **Expected:** Ошибки отображаются построчно, импорт частичный, журнал операций фиксирует результат.

### Scenario 7 — Real-time updates on secondary tab
- **Preconditions:** Открыты две вкладки (Dashboard и Real-time feed), активен WebSocket.
- **Steps:**
  1. В основной вкладке выполнить CRUD-действие.
  2. Наблюдать обновление списка в real-time вкладке.
  3. Проверить отсутствие дублирующих запросов REST.
- **Expected:** Обновление приходит по WS, UI обновляется мгновенно, соединение остаётся активным.

### Scenario 8 — WebSocket authorization refresh
- **Preconditions:** Включён механизм refresh токена; токен истекает через 1 минуту.
- **Steps:**
  1. Подключиться к WS.
  2. Дождаться истечения токена.
  3. Проверить автоматическое обновление и переподключение.
- **Expected:** WS переавторизуется без ручного вмешательства, сообщения не теряются.

### Scenario 9 — Notifications & audit trail
- **Preconditions:** Настроены триггеры уведомлений для CRUD.
- **Steps:**
  1. Выполнить создание и обновление сущности.
  2. Проверить inbox/всплывающие уведомления.
  3. Просмотреть журнал аудита.
- **Expected:** Нотификации доставляются нужным ролям, аудит содержит корректные метаданные.

### Scenario 10 — Error handling & fallback UI
- **Preconditions:** Настроены моки/инъекции ошибок 400, 401, 403, 404, 500.
- **Steps:**
  1. Вызвать каждую ошибку через UI.
  2. Проверить отображение сообщений и возможность повторной попытки.
  3. Проследить логирование на backend.
- **Expected:** UI показывает дружелюбные тексты, нет краша приложения, логи содержат полную информацию.

### Scenario 11 — Access revocation mid-session
- **Preconditions:** Пользователь manager активен; админ готов изменить роль.
- **Steps:**
  1. Менеджер выполняет операцию.
  2. Админ меняет роль менеджера на viewer.
  3. Менеджер пытается повторно выполнить операцию без обновления страницы.
- **Expected:** Сразу после изменения роль обновляется, дальнейшие операции блокируются (403), появляется уведомление.

### Scenario 12 — External integration sync
- **Preconditions:** Настроен интеграционный источник с mock API.
- **Steps:**
  1. Запустить синхронизацию из UI.
  2. Проверить статус задачи (в ожидании → выполнено/ошибка).
  3. Сверить количество импортированных записей и лог ошибок.
- **Expected:** Статусы обновляются корректно, данные синхронизированы, ошибки доступны для анализа.

### Scenario 13 — Offline-first & retry
- **Preconditions:** Включен сервис-воркер/offline кэш; есть черновой режим.
- **Steps:**
  1. Начать создание записи.
  2. Отключить сеть.
  3. Сохранить черновик локально.
  4. Восстановить сеть и отправить.
- **Expected:** Черновик сохраняется локально, после восстановления сеть отправка проходит успешно, нет дублей.

### Scenario 14 — Export & permissions
- **Preconditions:** Есть данные; ролям назначены права на экспорт.
- **Steps:**
  1. Админ выполняет экспорт CSV и PDF.
  2. Менеджер выполняет экспорт только CSV.
  3. Viewer пытается экспортировать.
- **Expected:** Экспорт у админа/менеджера проходит по правилам, viewer получает отказ; файлы содержат фильтрованные данные.

### Scenario 15 — Feature flag toggle
- **Preconditions:** Модуль Bonuses выключен.
- **Steps:**
  1. Включить feature flag через UI/конфиг.
  2. Перезагрузить страницу.
  3. Проверить доступность маршрутов и API.
  4. Выключить флаг.
- **Expected:** Модуль активируется/деактивируется без рестарта, UI/бэк корректно скрывают функционал.

### Scenario 16 — Session timeout & re-auth
- **Preconditions:** Настроен таймаут 15 минут, refresh-токен валиден.
- **Steps:**
  1. Авторизоваться и бездействовать 15 минут.
  2. Получить уведомление об истечении сессии.
  3. Выполнить ре-логин через refresh.
- **Expected:** Пользователь корректно разлогинен, после refresh получает новый access токен и восстанавливает состояние.

## # EDGE CASES
1. Создание сущности с пустыми обязательными полями.
2. Ввод числовых значений выше максимально допустимых (например, цена > 10^9).
3. Массовый импорт с дублирующими ID.
4. Параллельное редактирование одной записи двумя пользователями (race condition).
5. Удаление сущности, на которую ссылаются другие (проверка каскадов/валидации).
6. Фильтрация с недопустимыми символами (SQL/JS injection).
7. Сортировка по несуществующему полю через ручной URL.
8. Пагинация с page=0 или page=999999.
9. Просмотр без авторизации (прямой URL).
10. Попытка открытия WS без токена или с просроченным токеном.
11. Обрыв WebSocket соединения во время отправки сообщения.
12. Повторное подключение WS с параллельными сессиями.
13. Изменение роли пользователя пока открыт модальный диалог редактирования.
14. Экспорт большого объёма данных (>100k строк) при ограничении таймаута.
15. Импорт файла неправильного формата (jpg вместо csv).
16. Попытка включить feature flag без соответствующих прав.
17. Изменение конфигурации CORS и проверка доступа с нового домена.
18. Ошибка сериализации JSON (например, циклические ссылки).
19. Тайм-аут запросов API при нестабильной сети.
20. Применение refresh токена одновременно на разных устройствах.

## # NON-FUNCTIONAL
- **Производительность:**
  - CRUD-операции на объёме 10k, 25k и 50k записей (замер latency < 500 мс).
  - Массовый импорт/экспорт с профилированием БД и нагрузочным тестом (100 rps).
- **Доступность:**
  - Проверка работы при недоступности одной из служб (БД, очереди) и корректные fallback.
  - Мониторинг /health и /version, алерты по SLA 99.5%.
- **i18n:**
  - Переключение языков (ru/en/kk), проверка локализации дат/чисел.
  - Локализация ошибок и системных сообщений.
- **Безопасность:**
  - Проверка хранения токенов (httpOnly), защита от XSS/CSRF.
  - Валидация JWT, отзыв refresh токенов, логирование подозрительной активности.
  - Пен-тест основных эндпоинтов, проверка rate limiting.

## # CHECKLIST
1. API /health и /version отвечают 200.
2. Конфигурация env (DATABASE_URL, SECRET_KEY, CORS_ORIGINS, VITE_API_URL) заполнена.
3. Alembic миграции применены до head.
4. Линтеры и форматтеры пройдены (backend/frontend).
5. Юнит и интеграционные тесты зелёные.
6. WebSocket авторизация протестирована.
7. Реализована матрица ролей admin/manager/viewer.
8. Проверено восстановление сессии через refresh токен.
9. Настроена обработка ошибок и fallback UI.
10. Обновлён README с инструкциями по запуску.
11. Нагрузочные метрики в норме (latency, throughput).
12. i18n переводы обновлены и проверены.
13. Feature flags задокументированы и протестированы.
14. Реализована аудит-трассировка CRUD.
15. Настроены уведомления и каналы доставки.
16. Проверены фильтры, сортировка, пагинация.
17. CRUD операции проходят для всех ключевых сущностей.
18. Экспорт/импорт данных работает и логирует ошибки.
19. Проверена работа офлайн-режима и ретраев.
20. UI/UX review пройден, критичные баги закрыты.
21. Доступность для viewer без прав на модификацию подтверждена.
22. WS переподключение при истечении токена проверено.
23. Логи и мониторинг подключены (сбор метрик).
24. CORS настроен для фронтенда и Metabase.
25. План деплоя и роллбэка согласован.
